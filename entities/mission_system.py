import random
from utils.constants import MISSION_DURATION, CREDIT_INITIAL
from mini_games.terminal import MainTerminal


class MissionSystem:
    
    def __init__(self):
        self.current_mission = None
        self.mission_timer = 0
        self.available_missions = []
        self.ship_interaction_points = []
        
        # Syst√®me de paris
        self.betting_active = False
        self.bet_amount = 0
        self.bet_type = None  # "success" ou "failure"
        self.bet_placed = False
        self.bet_result = None
        
        # √âconomie
        self.gold=CREDIT_INITIAL
        
        # √âtat temporaire pour l'UI de pari
        self.temp_bet_type = None
        self.temp_bet_amount = 100

        # Ordonnancement des missions
        self.missions_assigned_count = 0

        self.terminal_on = False

        
        self.create_mission_templates()
    
    def create_mission_templates(self):
        self.available_missions = [
            {
                'name': 'Sauvetage de Colonie',
                'description': 'Sauver une colonie attaqu√©e par des pirates',
                'difficulty': 1,
                'duration': 45,
                'reward': 100
            },
            {
                'name': 'Exploration Plan√©taire',
                'description': "Explorer une plan√®te et trouver un artefact",
                'type': 'Exploration',
                'difficulty': 2,
                'duration': 60,
                'reward': 150
            },
            {
                'name': 'Exploration de Ruines',
                'description': 'Explorer d\'anciennes ruines alien',
                'difficulty': 2,
                'duration': 60,
                'reward': 150
            },
            {
                'name': '√âlimination de Menace',
                'description': '√âliminer une menace spatiale',
                'type': '√âlimination',
                'difficulty': 3,
                'duration': 90,
                'reward': 250
            },
            {
                'name': 'Livraison Urgente',
                'description': 'Livrer des fournitures m√©dicales',
                'difficulty': 1,
                'duration': 30,
                'reward': 80
            },
            {
                'name': 'Reconnaissance',
                'description': 'Effectuer une reconnaissance en territoire ennemi',
                'difficulty': 2,
                'duration': 75,
                'reward': 200
            }
        ]
    
    def set_hero(self, hero):
        self.hero = hero
    
    def start_random_mission(self):
        if not self.current_mission:
            # Premi√®re interaction: Exploration, seconde: √âlimination (mission finale)
            if self.missions_assigned_count == 0:
                exploration = [m for m in self.available_missions if m.get('type') == 'Exploration']
                mission_template = exploration[0] if exploration else random.choice(self.available_missions)
            else:
                elimination = [m for m in self.available_missions if m.get('type') == '√âlimination']
                mission_template = elimination[0] if elimination else random.choice(self.available_missions)
            
            self.current_mission = mission_template.copy()
            self.current_mission['progress'] = 0
            self.current_mission['start_time'] = self.mission_timer
            
            if self.hero:
                self.hero.start_mission(mission_template)
            
            # R√©compense imm√©diate de vente de mission
            self.gold += 100
            self.missions_assigned_count += 1
            
            print(f"Mission '{self.current_mission['name']}' assign√©e au h√©ros!")
    
    def update(self, delta_time):
        self.mission_timer += delta_time
        
        if self.current_mission:
            # Mettre √† jour la progression de la mission
            if self.hero:
                self.current_mission['progress'] = self.hero.get_progress_percentage()
                
                # V√©rifier si la mission de bataille est termin√©e
                if (self.hero.battle_mission and 
                    self.hero.battle_mission.mission_completed):
                    self.complete_mission()
                # V√©rifier si la mission est termin√©e normalement
                elif self.hero.is_mission_complete():
                    self.complete_mission()
                elif self.hero.is_mission_failed():
                    self.fail_mission()
                elif self.mission_timer - self.current_mission['start_time'] > self.current_mission['duration']:
                    self.timeout_mission()
    
    def complete_mission(self):
        if self.current_mission:
            print(f"Mission '{self.current_mission['name']}' r√©ussie!")
            self.current_mission = None
    
    def fail_mission(self):
        if self.current_mission:
            print(f"Mission '{self.current_mission['name']}' √©chou√©e!")
            self.current_mission = None
    
    def timeout_mission(self):
        if self.current_mission:
            print(f"Mission '{self.current_mission['name']}' expir√©e!")
            self.current_mission = None
    
    def get_nearby_interactions(self, agent_x):
        # Retourner les points d'interaction √† proximit√© de l'agent
        nearby = []
        for point in self.ship_interaction_points:
            if abs(point['x'] - agent_x) < 50:
                nearby.append(point)
        return nearby
    
    def interact_with_point(self, point_name):
        # G√©rer les interactions avec les points d'int√©r√™t
        if point_name == "Bureau des Missions":
            if not self.current_mission:
                self.start_random_mission()
                return "Mission assign√©e au h√©ros !"
            else:
                return "Une mission est d√©j√† en cours."
        elif point_name == "Am√©lioration Surveillance":
            return "Surveillance am√©lior√©e !"
        elif point_name == "Station de Paris":
            if not self.current_mission:
                return "Aucune mission active pour parier."
            elif self.bet_placed:
                return "Un pari est d√©j√† plac√© sur cette mission."
            else:
                self.betting_active = True
                self.temp_bet_type = None
                self.temp_bet_amount = min(100, max(10, self.gold)) if self.gold > 0 else 0
                return "Interface de paris ouverte !"
        elif point_name == "Analyse de Donn√©es":
            return "Donn√©es analys√©es !"
        elif point_name == "Terminal":
            self.terminal_on = True
        else:
            return "Interaction effectu√©e."
    
    def set_ship_interaction_points(self, points):
        self.ship_interaction_points = points
    
    def place_bet(self, bet_type, amount):
        # Placer un pari sur la mission
        if not self.current_mission:
            return "Aucune mission active."
        if self.bet_placed:
            return "Un pari est d√©j√† plac√©."
        if amount <= 0:
            return "Montant invalide."
        if amount > self.gold:
            return "Fonds insuffisants."
        
        self.bet_type = bet_type  # "success" ou "failure"
        self.bet_amount = amount
        self.bet_placed = True
        self.betting_active = False
        # D√©biter imm√©diatement les fonds pari√©s
        self.gold -= amount
        
        return f"Pari de {amount} cr√©dits plac√© sur {bet_type} !"
    
    def calculate_bet_result(self):
        # Calculer le r√©sultat du pari
        if not self.bet_placed:
            return None
        
        # D√©terminer si la MISSION DE BATAILLE (mission principale du h√©ros) a r√©ussi
        # C'est sur cette mission qu'on parie
        mission_success = False
        
        if self.hero and self.hero.battle_mission:
            # La mission de bataille est r√©ussie si des ennemis ont √©t√© d√©truits
            mission_success = self.hero.battle_mission.enemies_destroyed > 0
            print(f"Debug - Mission de bataille du h√©ros:")
            print(f"Debug - Ennemis d√©truits: {self.hero.battle_mission.enemies_destroyed}")
            print(f"Debug - Mission de bataille r√©ussie: {mission_success}")
        else:
            # Fallback pour d'autres types de missions
            mission_success = self.hero.is_mission_complete() if self.hero else False
            print(f"Debug - Mission r√©ussie (autre type): {mission_success}")
        
        # Cr√©er un r√©sultat d√©taill√©
        self.bet_result = {
            'bet_type': self.bet_type,
            'bet_amount': self.bet_amount,
            'mission_success': mission_success,
            'won': False,
            'winnings': 0,
            'message': ""
        }
        
        # Calculer les gains/pertes
        if self.bet_type == "success" and mission_success:
            # Pari gagn√© sur la r√©ussite de la MISSION DE BATAILLE
            self.bet_result['won'] = True
            self.bet_result['winnings'] = self.bet_amount * 2
            self.bet_result['message'] = f"üéâ PARI GAGN√â ! üéâ\nVous aviez pari√© sur la R√âUSSITE\nMission de bataille du h√©ros: R√âUSSIE ‚úÖ\nGains: +{self.bet_result['winnings']} cr√©dits"
            # Cr√©diter l'or (double du montant mis√©)
            self.gold += self.bet_result['winnings']
        elif self.bet_type == "failure" and not mission_success:
            # Pari gagn√© sur l'√©chec de la MISSION DE BATAILLE
            self.bet_result['won'] = True
            self.bet_result['winnings'] = self.bet_amount * 2
            self.bet_result['message'] = f"üéâ PARI GAGN√â ! üéâ\nVous aviez pari√© sur l'√âCHEC\nMission de bataille du h√©ros: √âCHOU√âE ‚ùå\nGains: +{self.bet_result['winnings']} cr√©dits"
            # Cr√©diter l'or (double du montant mis√©)
            self.gold += self.bet_result['winnings']
        else:
            # Pari perdu
            self.bet_result['won'] = False
            self.bet_result['winnings'] = -self.bet_amount
            if self.bet_type == "success":
                self.bet_result['message'] = f"üí∏ PARI PERDU üí∏\nVous aviez pari√© sur la R√âUSSITE\nMission de bataille du h√©ros: √âCHOU√âE ‚ùå\nPertes: -{self.bet_amount} cr√©dits"
            else:
                self.bet_result['message'] = f"üí∏ PARI PERDU üí∏\nVous aviez pari√© sur l'√âCHEC\nMission de bataille du h√©ros: R√âUSSIE ‚úÖ\nPertes: -{self.bet_amount} cr√©dits"
        
        return self.bet_result
    
    def close_betting_interface(self):
        self.betting_active = False
    
    def get_betting_info(self):
        if not self.betting_active:
            return None
        
        return {
            'mission_name': self.current_mission['name'] if self.current_mission else "Aucune",
            'mission_progress': self.hero.get_progress_percentage() if self.hero else 0,
            'hero_health': self.hero.get_health_percentage() if self.hero else 0,
            'gold': self.gold,
            'temp_bet_type': self.temp_bet_type,
            'temp_bet_amount': self.temp_bet_amount
        }
    
    def is_mission_finished(self):
        # V√©rifier si la mission est termin√©e
        if not self.current_mission:
            return False
        
        if self.hero and self.hero.battle_mission:
            return self.hero.battle_mission.is_mission_finished()
        
        return False
